{"version":3,"sources":["../src/FormControl.jsx"],"names":["props","values","fields","Object","keys","forEach","name","value","state","validator","assign","FormComponent","nextProps","onChange","newValue","assembleFieldValidate","setState","schema","schemas","validateByField","result","error","message","formValues","handleChange","handleValidate","handleValidateByName","handleAddFields","handleRemoveFields","handleAddSchemas","handleRemoveSchemas","propTypes","object","isRequired","func","addFields","removeFields","e","target","type","theValue","slice","index","findIndex","item","push","splice","validateField","names","newFields","validateFields","every"],"mappings":"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","file":"FormControl.js","sourcesContent":["/**\n * Created by MingYi on 2016/12/23.\n */\n\nimport React, { Component, PropTypes } from 'react';\nimport Validator from 'validate-framework-utils';\n\n/**\n * 包装组件方法\n * @param schemas\n */\nexport default schemas => FormComponent => (\n\n  /**\n   * 验证组件\n   */\n  class FormControl extends Component {\n\n    static propTypes = {\n      values: PropTypes.object.isRequired,\n      onChange: PropTypes.func,\n      addFields: PropTypes.func,\n      removeFields: PropTypes.func,\n    };\n\n    constructor(props) {\n      super(props);\n      const values = props.values;\n\n      // 将初始化数据组装成 fields\n      const fields = {};\n      Object.keys(values).forEach((name) => {\n        fields[name] = {\n          value: values[name],\n        };\n      });\n\n      this.state = {\n        fields,\n      };\n\n      // 初始化验证组件\n      this.validator = new Validator();\n      Object.assign(this.validator, FormComponent.validator);\n    }\n\n    componentWillReceiveProps(nextProps) {\n      // 受控组件从父组件中更新 state\n      const { values, onChange } = nextProps;\n      if (!onChange) {\n        return;\n      }\n      const { fields } = this.state;\n      Object.keys(values).forEach((name) => {\n        const newValue = values[name];\n        // 存在，则验证新的数据\n        if (fields[name]) {\n          // diff 验证\n          if (fields[name].value !== newValue) {\n            this.assembleFieldValidate(name, newValue);\n          }\n        } else {\n          // 添加新的 field\n          fields[name] = {\n            value: newValue,\n          };\n        }\n      });\n\n      this.setState({\n        fields,\n      });\n    }\n\n    /**\n     * 获取表单值列表\n     * @return {Object}\n     */\n    get formValues() {\n      const { fields } = this.state;\n      const values = {};\n      Object.keys(fields).forEach((name) => {\n        values[name] = fields[name].value;\n      });\n      return values;\n    }\n\n    /**\n     * 组装数据\n     * 此方法改变了状态，下个组件中集中更新 state\n     * @param name\n     * @param value\n     */\n    assembleFieldValidate(name, value) {\n      const { fields } = this.state;\n      // 验证\n      // 无 schema 则不验证\n      const schema = schemas[name] && Object.assign(schemas[name], { value });\n      const { result, error } = schema ? this.validator.validateByField(schema) : {};\n\n      // 组装\n      Object.assign(fields[name], {\n        value,\n        result,\n        message: error ? error.message : null,\n      });\n    }\n\n    /**\n     * 验证单个域\n     * @param name\n     * @param value\n     * @return {Boolean}\n     */\n    validateField(name, value) {\n      const { fields } = this.state;\n      // 组装数据\n      this.assembleFieldValidate(name, value);\n      // 集中更新\n      this.setState({\n        fields,\n      });\n\n      return fields[name].result;\n    }\n\n    /**\n     * 验证所有\n     * @return {Object} fields\n     */\n    validateFields() {\n      const { fields } = this.state;\n      Object.keys(schemas).forEach((name) => {\n        // 组装数据\n        this.assembleFieldValidate(name, fields[name].value);\n      });\n      // 集中更新\n      this.setState({\n        fields,\n      });\n    }\n\n    // 表单改变事件监听\n    handleChange = (e) => {\n      // 受控组件让父组件管理改变事件\n      const { onChange } = this.props;\n      if (onChange) {\n        onChange(e);\n        return;\n      }\n\n      const { name, type, value } = e.target;\n      const { fields } = this.state;\n\n      // 依赖 name 属性\n      if (!name) {\n        return;\n      }\n\n      let theValue;\n      // checkbox 处理\n      if (type === 'checkbox') {\n        theValue = fields[name].value.slice();\n        const index = theValue.findIndex(item => item === value);\n        if (index === -1) {\n          theValue.push(value);\n        } else {\n          theValue.splice(index, 1);\n        }\n      } else {\n        theValue = value;\n      }\n\n      // 验证并更新\n      this.validateField(name, theValue);\n    };\n\n    /**\n     * 添加一条或多条验证规则\n     * @param schema\n     */\n    handleAddSchemas = (schema) => {\n      Object.assign(schemas, schema);\n    };\n\n    /**\n     * 删除一条或多条验证规则\n     * @param names\n     */\n    handleRemoveSchemas = (names) => {\n      names.forEach((name) => {\n        delete schemas[name]; // eslint-disable-line no-param-reassign\n      });\n    };\n\n    /**\n     * 添加一条或多条域\n     * @param newFields\n     */\n    handleAddFields = (newFields) => {\n      const { addFields } = this.props;\n      const { fields } = this.state;\n      Object.assign(fields, newFields);\n      this.setState({\n        fields,\n      });\n      // 调用父组件添加域\n      if (addFields) {\n        addFields(newFields);\n      }\n    };\n\n    /**\n     * 删除一条或多条域\n     * @param names\n     */\n    handleRemoveFields = (names) => {\n      const { removeFields } = this.props;\n      const { fields } = this.state;\n      names.forEach((name) => {\n        delete fields[name];\n      });\n      this.setState({\n        fields,\n      });\n      // 调用父组件删除域\n      if (removeFields) {\n        removeFields(names);\n      }\n    };\n\n    /**\n     * 通过 name 手动验证单个组件\n     * @param name\n     * @return {Boolean}\n     */\n    handleValidateByName = (name) => {\n      const { fields } = this.state;\n      const value = fields[name].value;\n      return this.validateField(name, value);\n    };\n\n    // 验证当前组件\n    handleValidate = () => {\n      // 验证\n      this.validateFields();\n      const { fields } = this.state;\n      // 排除 验证成功 和 未验证 状态\n      return Object.keys(fields).every(name => fields[name].result !== false);\n    };\n\n    render() {\n      const { fields } = this.state;\n\n      return (\n        <FormComponent\n          {...this.props}\n          fields={fields}\n          formValues={this.formValues}\n          onChange={this.handleChange}\n          validate={this.handleValidate}\n          validateByName={this.handleValidateByName}\n          addFields={this.handleAddFields}\n          removeFields={this.handleRemoveFields}\n          addSchemas={this.handleAddSchemas}\n          removeSchemas={this.handleRemoveSchemas}\n        />\n      );\n    }\n  }\n);\n"]}