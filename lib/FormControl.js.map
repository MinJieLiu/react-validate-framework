{"version":3,"sources":["../src/FormControl.jsx"],"names":["required","field","Array","isArray","value","length","props","values","fields","Object","keys","forEach","name","state","validator","assign","FormComponent","nextProps","onChange","newValue","assembleFieldValidate","setState","schema","schemas","validateByField","result","error","message","formValues","handleChange","handleValidate","handleValidateByName","handleAddFields","handleRemoveFields","propTypes","object","isRequired","func","addFields","removeFields","e","target","type","theValue","slice","index","findIndex","item","push","splice","validateField","newFields","names","validateFields","every"],"mappings":"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","file":"FormControl.js","sourcesContent":["/**\r\n * Created by MingYi on 2016/12/23.\r\n */\r\n\r\nimport React, { Component, PropTypes } from 'react';\r\nimport validateFramework from 'validate-framework/lib/validate';\r\n\r\n/**\r\n * 扩展必填验证方法，支持数组判断\r\n * @param field\r\n * @return {boolean}\r\n */\r\nvalidateFramework.required = (field) => {\r\n  if (typeof field === 'string') {\r\n    return field !== '';\r\n  } else if (Array.isArray(field.value)) {\r\n    return field.value.length;\r\n  }\r\n  return field.value !== null && field.value !== '';\r\n};\r\n\r\n/**\r\n * 包装组件方法\r\n * @param schemas\r\n */\r\nexport default schemas => FormComponent => (\r\n\r\n  /**\r\n   * 验证组件\r\n   */\r\n  class FormControl extends Component {\r\n\r\n    static propTypes = {\r\n      values: PropTypes.object.isRequired,\r\n      onChange: PropTypes.func,\r\n      addFields: PropTypes.func,\r\n      removeFields: PropTypes.func,\r\n    };\r\n\r\n    constructor(props) {\r\n      super(props);\r\n      const values = props.values;\r\n\r\n      // 将初始化数据组装成 fields\r\n      const fields = {};\r\n      Object.keys(values).forEach((name) => {\r\n        fields[name] = {\r\n          value: values[name],\r\n        };\r\n      });\r\n\r\n      this.state = {\r\n        fields,\r\n      };\r\n\r\n      // 自定义验证方法\r\n      this.validator = Object.assign(validateFramework, FormComponent.validator);\r\n    }\r\n\r\n    componentWillReceiveProps(nextProps) {\r\n      // 受控组件从父组件中更新 state\r\n      const { values, onChange } = nextProps;\r\n      if (!onChange) {\r\n        return;\r\n      }\r\n      const { fields } = this.state;\r\n      Object.keys(values).forEach((name) => {\r\n        const newValue = values[name];\r\n        // 存在，则验证新的数据\r\n        if (fields[name]) {\r\n          // diff 验证\r\n          if (fields[name].value !== newValue) {\r\n            this.assembleFieldValidate(name, newValue);\r\n          }\r\n        } else {\r\n          // 添加新的 field\r\n          fields[name] = {\r\n            value: newValue,\r\n          }\r\n        }\r\n      });\r\n\r\n      this.setState({\r\n        fields,\r\n      });\r\n    }\r\n\r\n    /**\r\n     * 获取表单值列表\r\n     * @return {Object}\r\n     */\r\n    get formValues() {\r\n      const { fields } = this.state;\r\n      const values = {};\r\n      Object.keys(fields).forEach((name) => {\r\n        values[name] = fields[name].value;\r\n      });\r\n      return values;\r\n    }\r\n\r\n    /**\r\n     * 组装数据\r\n     * 此方法改变了状态，下个组件中集中更新 state\r\n     * @param name\r\n     * @param value\r\n     */\r\n    assembleFieldValidate(name, value) {\r\n      const { fields } = this.state;\r\n      // 验证\r\n      // 无 schema 则不验证\r\n      const schema = schemas[name] && Object.assign(schemas[name], { value });\r\n      const { result, error } = schema ? this.validator.validateByField(schema) : {};\r\n\r\n      // 组装\r\n      Object.assign(fields[name], {\r\n        value,\r\n        result,\r\n        message: error ? error.message : null,\r\n      });\r\n    }\r\n\r\n    /**\r\n     * 验证单个域\r\n     * @param name\r\n     * @param value\r\n     * @return {Boolean}\r\n     */\r\n    validateField(name, value) {\r\n      const { fields } = this.state;\r\n      // 组装数据\r\n      this.assembleFieldValidate(name, value);\r\n      // 集中更新\r\n      this.setState({\r\n        fields,\r\n      });\r\n\r\n      return fields[name].result;\r\n    }\r\n\r\n    /**\r\n     * 验证所有\r\n     * @return {Object} fields\r\n     */\r\n    validateFields() {\r\n      const { fields } = this.state;\r\n      Object.keys(schemas).forEach((name) => {\r\n        // 组装数据\r\n        this.assembleFieldValidate(name, fields[name].value);\r\n      });\r\n      // 集中更新\r\n      this.setState({\r\n        fields,\r\n      });\r\n    }\r\n\r\n    // 表单改变事件监听\r\n    handleChange = (e) => {\r\n      // 受控组件让父组件管理改变事件\r\n      const { onChange } = this.props;\r\n      if (onChange) {\r\n        onChange(e);\r\n        return;\r\n      }\r\n\r\n      const { name, type, value } = e.target;\r\n      const { fields } = this.state;\r\n\r\n      // 依赖 name 属性\r\n      if (!name) {\r\n        return;\r\n      }\r\n\r\n      let theValue;\r\n      // checkbox 处理\r\n      if (type === 'checkbox') {\r\n        theValue = fields[name].value.slice();\r\n        const index = theValue.findIndex(item => item === value);\r\n        if (index === -1) {\r\n          theValue.push(value);\r\n        } else {\r\n          theValue.splice(index, 1);\r\n        }\r\n      } else {\r\n        theValue = value;\r\n      }\r\n\r\n      // 验证并更新\r\n      this.validateField(name, theValue);\r\n    };\r\n\r\n    /**\r\n     * 添加一条或多条域\r\n     * @param newFields\r\n     */\r\n    handleAddFields = (newFields) => {\r\n      const { addFields } = this.props;\r\n      const { fields } = this.state;\r\n      Object.assign(fields, newFields);\r\n      this.setState({\r\n        fields,\r\n      });\r\n      // 调用父组件添加域\r\n      if (addFields) {\r\n        addFields(newFields);\r\n      }\r\n    };\r\n\r\n    /**\r\n     * 删除一条或多条域\r\n     * @param names\r\n     */\r\n    handleRemoveFields = (names) => {\r\n      const { removeFields } = this.props;\r\n      const { fields } = this.state;\r\n      names.forEach((name) => {\r\n        delete fields[name];\r\n      });\r\n      this.setState({\r\n        fields,\r\n      });\r\n      // 调用父组件删除域\r\n      if (removeFields) {\r\n        removeFields(names);\r\n      }\r\n    };\r\n\r\n    /**\r\n     * 通过 name 手动验证单个组件\r\n     * @param name\r\n     * @return {Boolean}\r\n     */\r\n    handleValidateByName = (name) => {\r\n      const { fields } = this.state;\r\n      const value = fields[name].value;\r\n      return this.validateField(name, value);\r\n    };\r\n\r\n    // 验证当前组件\r\n    handleValidate = () => {\r\n      // 验证\r\n      this.validateFields();\r\n      const { fields } = this.state;\r\n      // 排除 验证成功 和 未验证 状态\r\n      return Object.keys(fields).every(name => fields[name].result !== false);\r\n    };\r\n\r\n    render() {\r\n      const { fields } = this.state;\r\n\r\n      return (\r\n        <FormComponent\r\n          {...this.props}\r\n          fields={fields}\r\n          formValues={this.formValues}\r\n          onChange={this.handleChange}\r\n          validate={this.handleValidate}\r\n          validateByName={this.handleValidateByName}\r\n          addFields={this.handleAddFields}\r\n          removeFields={this.handleRemoveFields}\r\n        />\r\n      );\r\n    }\r\n  }\r\n);\r\n"]}